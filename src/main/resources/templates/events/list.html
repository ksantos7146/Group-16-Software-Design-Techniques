<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/main}">
<head>
    <title>Events - Get Vibe</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Events</h1>
                <a th:href="@{/events/create}" class="btn btn-primary" sec:authorize="isAuthenticated()">
                    Create Event
                </a>
            </div>

            <div class="row" id="eventsList">
                <!-- Events will be loaded here dynamically -->
            </div>

            <div class="row mt-4" id="debugPanel">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center bg-light">
                            <h5 class="mb-0">Debug Panel</h5>
                            <button class="btn btn-sm btn-primary" onclick="runDebug()">Run Debug Check</button>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div id="apiStatus">API Status: <span class="badge bg-secondary">Not checked</span></div>
                                <div id="debugResults" class="mt-2"></div>
                            </div>
                            <div class="d-flex">
                                <button class="btn btn-sm btn-secondary me-2" onclick="checkAPI()">Check API</button>
                                <button class="btn btn-sm btn-warning me-2" onclick="testRawAPI()">Test Raw API</button>
                                <button class="btn btn-sm btn-info" onclick="viewDebugData()">View Debug Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div layout:fragment="scripts">
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                fetchEvents();
            });

            function fetchEvents() {
                console.log('Fetching events...');
                fetch('/events/api')
                    .then(response => {
                        console.log('API response status:', response.status);
                        if (!response.ok) {
                            throw new Error('Network response was not ok: ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(events => {
                        console.log('Events received from API:', events);
                        console.log('Number of events:', events.length);
                        console.log('Raw events data:', JSON.stringify(events));
                        
                        if (!events || events.length === 0) {
                            document.getElementById('eventsList').innerHTML = 
                                '<div class="col-12"><div class="alert alert-info">No events found. Create one!</div></div>';
                            return;
                        }
                        
                        const eventsList = document.getElementById('eventsList');
                        eventsList.innerHTML = events.map(event => {
                            console.log('Processing event:', event);
                            // Check if event dates are valid
                            const startDate = new Date(event.startTime);
                            const endDate = new Date(event.endTime);
                            const hasDateIssue = startDate > endDate;
                            
                            return `
                                <div class="col-md-4 mb-4">
                                    <div class="card h-100 ${hasDateIssue ? 'border-warning' : ''}">
                                        ${hasDateIssue ? '<div class="badge bg-warning text-dark position-absolute" style="top:10px;right:10px;">Date issue!</div>' : ''}
                                        <div class="card-img-top" style="height: 200px; background-size: cover; background-position: center; 
                                             background-image: url('${event.image && event.image.id ? `/api/images/${event.image.id}` : '/api/images/default-event'}')"></div>
                                        <div class="card-body">
                                            <h5 class="card-title">${event.title}</h5>
                                            <p class="card-text">${event.description ? event.description.substring(0, 100) + (event.description.length > 100 ? '...' : '') : 'No description'}</p>
                                            <p class="card-text">
                                                <small class="${hasDateIssue ? 'text-danger' : 'text-muted'}">
                                                    <i class="fas fa-calendar"></i> 
                                                    ${hasDateIssue ? 'Date issue: ' : ''}
                                                    Start: ${startDate.toLocaleString()} <br>
                                                    End: ${endDate.toLocaleString()}
                                                </small>
                                            </p>
                                            ${hasDateIssue ? `
                                            <button class="btn btn-warning btn-sm mb-2" onclick="fixEventDates(${event.id}, '${event.title}')">Fix Dates</button>
                                            ` : ''}
                                            <a href="/events/${event.id}" class="btn btn-primary">View Details</a>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    })
                    .catch(error => {
                        console.error('Error fetching events:', error);
                        document.getElementById('eventsList').innerHTML = 
                            '<div class="col-12"><div class="alert alert-danger">Error loading events: ' + error.message + '</div></div>';
                    });
            }

            function fixEventDates(eventId, eventTitle) {
                // Get the current date plus 1 hour for start time
                const startTime = new Date();
                // Add 2 hours for end time
                const endTime = new Date(startTime.getTime() + (2 * 60 * 60 * 1000));
                
                const eventData = {
                    title: eventTitle,
                    startTime: startTime.toISOString(),
                    endTime: endTime.toISOString()
                };
                
                if (confirm('Fix dates for "' + eventTitle + '"?\n\nStart: ' + startTime.toLocaleString() + '\nEnd: ' + endTime.toLocaleString())) {
                    fetch(`/events/api/${eventId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(eventData)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to update event');
                        }
                        return response.json();
                    })
                    .then(data => {
                        alert('Event dates fixed successfully');
                        // Refresh the events list
                        fetchEvents();
                    })
                    .catch(error => {
                        console.error('Error fixing event dates:', error);
                        alert('Error fixing event dates: ' + error.message);
                    });
                }
            }

            function checkAPI() {
                fetch('/events/api')
                    .then(response => {
                        document.getElementById('apiStatus').innerHTML = 
                            `API Status: <span class="badge ${response.ok ? 'bg-success' : 'bg-danger'}">
                            ${response.status} ${response.statusText}</span>`;
                        return response.text();
                    })
                    .then(text => {
                        try {
                            // Try to parse as JSON
                            const data = JSON.parse(text);
                            document.getElementById('debugResults').innerHTML = 
                                `<pre class="bg-light p-3">${JSON.stringify(data, null, 2)}</pre>`;
                        } catch (e) {
                            // Not JSON, show as text
                            document.getElementById('debugResults').innerHTML = 
                                `<pre class="bg-light p-3">${text}</pre>`;
                        }
                    })
                    .catch(error => {
                        document.getElementById('apiStatus').innerHTML = 
                            `API Status: <span class="badge bg-danger">Error: ${error.message}</span>`;
                    });
            }

            function testRawAPI() {
                fetch('/events/api/debug')
                    .then(response => response.text())
                    .then(text => {
                        document.getElementById('debugResults').innerHTML = 
                            `<pre class="bg-light p-3">${text}</pre>`;
                    })
                    .catch(error => {
                        document.getElementById('debugResults').innerHTML = 
                            `<pre class="bg-light p-3">Error: ${error.message}</pre>`;
                    });
            }

            function viewDebugData() {
                const debugInfo = {
                    browser: navigator.userAgent,
                    url: window.location.href,
                    date: new Date().toISOString()
                };
                
                document.getElementById('debugResults').innerHTML = 
                    `<pre class="bg-light p-3">${JSON.stringify(debugInfo, null, 2)}</pre>`;
            }

            function runDebug() {
                // Perform a series of checks
                document.getElementById('debugResults').innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
                
                Promise.all([
                    fetch('/events/api').then(r => r.ok ? r.json() : { error: r.status }),
                    fetch('/events/api/debug').then(r => r.ok ? r.text() : { error: r.status })
                ])
                .then(([apiData, debugData]) => {
                    const report = {
                        timestamp: new Date().toISOString(),
                        apiEndpoint: {
                            status: 'OK',
                            data: apiData
                        },
                        debugEndpoint: {
                            status: 'OK',
                            data: debugData
                        }
                    };
                    
                    document.getElementById('debugResults').innerHTML = 
                        `<pre class="bg-light p-3">${JSON.stringify(report, null, 2)}</pre>`;
                })
                .catch(error => {
                    document.getElementById('debugResults').innerHTML = 
                        `<pre class="bg-light p-3">Error running debug: ${error.message}</pre>`;
                });
            }
        </script>
    </div>
</body>
</html> 