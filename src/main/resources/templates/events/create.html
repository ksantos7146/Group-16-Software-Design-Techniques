<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/main}">
<head>
    <title>Create Event - Get Vibe</title>
    <style>
        .form-group {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="container mt-5">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="text-center">Create New Event</h3>
                        </div>
                        <div class="card-body">
                            <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
                            <form id="createEventForm">
                                <div class="form-group mb-3">
                                    <label for="title">Event Title</label>
                                    <input type="text" class="form-control" id="title" name="title" required>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="description">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="startTime">Start Date/Time</label>
                                            <input type="datetime-local" class="form-control" id="startTime" name="startTime" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="endTime">End Date/Time</label>
                                            <input type="datetime-local" class="form-control" id="endTime" name="endTime" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="capacity">Capacity</label>
                                    <input type="number" class="form-control" id="capacity" name="capacity" min="1">
                                    <small class="form-text text-muted">Leave empty for unlimited capacity</small>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="categories">Categories</label>
                                    <select class="form-select" id="categories" name="categories" multiple>
                                        <option value="MUSIC">Music</option>
                                        <option value="ARTS">Arts</option>
                                        <option value="SPORTS">Sports</option>
                                        <option value="TECHNOLOGY">Technology</option>
                                        <option value="FOOD">Food</option>
                                        <option value="BUSINESS">Business</option>
                                        <option value="EDUCATION">Education</option>
                                        <option value="HEALTH">Health</option>
                                        <option value="TRAVEL">Travel</option>
                                        <option value="OTHER">Other</option>
                                    </select>
                                    <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple categories</small>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="eventImage">Event Image</label>
                                    <div class="input-group">
                                        <input type="file" class="form-control" id="eventImage" accept="image/*">
                                        <button class="btn btn-outline-secondary" type="button" id="uploadImageBtn">Upload</button>
                                    </div>
                                    <div id="uploadStatusContainer" class="mt-2" style="display: none;">
                                        <div class="progress">
                                            <div id="uploadProgressBar" class="progress-bar" role="progressbar" style="width: 0%;" 
                                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                        </div>
                                        <div id="uploadStatus" class="form-text"></div>
                                    </div>
                                    <div id="imagePreviewContainer" class="mt-2" style="display: none;">
                                        <div class="card">
                                            <img id="imagePreview" class="card-img-top" style="max-height: 200px; object-fit: cover;">
                                            <div class="card-body">
                                                <h6 class="card-title">Image Preview</h6>
                                                <p id="imageInfo" class="card-text small"></p>
                                                <button type="button" class="btn btn-sm btn-danger" id="removeImageBtn">Remove</button>
                                            </div>
                                        </div>
                                        <input type="hidden" id="imageId" name="imageId">
                                    </div>
                                    <small class="form-text text-muted">Upload an image for your event (maximum size: 5MB)</small>
                                </div>
                                
                                <h5 class="mt-4">Event Location</h5>
                                <div id="locationForm">
                                    <div class="form-group mb-3">
                                        <label for="placeName">Location Name</label>
                                        <input type="text" class="form-control" id="placeName" name="placeName" required>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="latitude">Latitude</label>
                                                <input type="number" step="0.000001" class="form-control" id="latitude" name="latitude" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="longitude">Longitude</label>
                                                <input type="number" step="0.000001" class="form-control" id="longitude" name="longitude" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="address">Address</label>
                                        <textarea class="form-control" id="address" name="address" rows="2" required></textarea>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 mt-4">
                                    <button type="submit" class="btn btn-primary">Create Event</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('createEventForm');
                const errorMessage = document.getElementById('errorMessage');
                const uploadImageBtn = document.getElementById('uploadImageBtn');
                const eventImageInput = document.getElementById('eventImage');
                const imagePreviewContainer = document.getElementById('imagePreviewContainer');
                const imagePreview = document.getElementById('imagePreview');
                const imageIdInput = document.getElementById('imageId');
                const removeImageBtn = document.getElementById('removeImageBtn');
                
                // Handle image upload
                uploadImageBtn.addEventListener('click', async function() {
                    if (!eventImageInput.files || eventImageInput.files.length === 0) {
                        alert('Please select an image to upload.');
                        return;
                    }
                    
                    const file = eventImageInput.files[0];
                    if (!file.type.startsWith('image/')) {
                        alert('Please select a valid image file.');
                        return;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Image size exceeds the 5MB limit.');
                        return;
                    }
                    
                    try {
                        // Show upload status
                        uploadImageBtn.textContent = 'Processing...';
                        uploadImageBtn.disabled = true;
                        const statusContainer = document.getElementById('uploadStatusContainer');
                        const statusText = document.getElementById('uploadStatus');
                        const progressBar = document.getElementById('uploadProgressBar');
                        
                        statusContainer.style.display = 'block';
                        statusText.textContent = 'Reading file...';
                        progressBar.style.width = '10%';
                        progressBar.textContent = '10%';
                        progressBar.setAttribute('aria-valuenow', 10);
                        
                        // Convert the image to base64
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            try {
                                statusText.textContent = 'Converting to base64...';
                                progressBar.style.width = '50%';
                                progressBar.textContent = '50%';
                                progressBar.setAttribute('aria-valuenow', 50);
                                
                                // Get the base64 string (remove the data:image/xyz;base64, prefix)
                                const base64String = e.target.result.split(',')[1];
                                
                                // Prepare the request data
                                const requestData = {
                                    fileName: file.name,
                                    imageData: base64String,
                                    contentType: file.type
                                };
                                
                                statusText.textContent = 'Uploading to server...';
                                progressBar.style.width = '70%';
                                progressBar.textContent = '70%';
                                progressBar.setAttribute('aria-valuenow', 70);
                                
                                // Send the request
                                const response = await fetch('/api/images/upload', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(requestData)
                                });
                                
                                progressBar.style.width = '100%';
                                progressBar.textContent = '100%';
                                progressBar.setAttribute('aria-valuenow', 100);
                                
                                if (!response.ok) {
                                    const errorText = await response.text();
                                    console.error('Upload error response:', errorText);
                                    throw new Error(errorText || 'Image upload failed');
                                }
                                
                                const data = await response.json();
                                console.log('Upload response:', data);
                                
                                // Store the image ID and display preview
                                imageIdInput.value = data.id;
                                
                                // Create a preview URL from the base64 data
                                imagePreview.src = `data:${file.type};base64,${base64String}`;
                                imagePreviewContainer.style.display = 'block';
                                
                                // Set image info text
                                document.getElementById('imageInfo').textContent = `ID: ${data.id} | File: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                                
                                // Hide status after a delay
                                setTimeout(() => {
                                    statusContainer.style.display = 'none';
                                }, 1500);
                                
                                // Reset the file input
                                eventImageInput.value = '';
                                statusText.textContent = 'Upload successful!';
                            } catch (error) {
                                document.getElementById('uploadStatus').textContent = 'Upload failed: ' + error.message;
                                document.getElementById('uploadProgressBar').classList.add('bg-danger');
                                alert('Failed to upload image: ' + error.message);
                                console.error('Upload error:', error);
                            } finally {
                                uploadImageBtn.textContent = 'Upload';
                                uploadImageBtn.disabled = false;
                            }
                        };
                        
                        reader.onerror = function() {
                            statusText.textContent = 'Error reading file';
                            progressBar.classList.add('bg-danger');
                            uploadImageBtn.textContent = 'Upload';
                            uploadImageBtn.disabled = false;
                        };
                        
                        // Start reading the file as a data URL (base64)
                        reader.readAsDataURL(file);
                    } catch (error) {
                        document.getElementById('uploadStatus').textContent = 'Upload failed: ' + error.message;
                        document.getElementById('uploadProgressBar').classList.add('bg-danger');
                        alert('Failed to upload image: ' + error.message);
                        console.error('Upload error:', error);
                        uploadImageBtn.textContent = 'Upload';
                        uploadImageBtn.disabled = false;
                    }
                });
                
                // Handle removing the image
                removeImageBtn.addEventListener('click', async function() {
                    const imageId = imageIdInput.value;
                    if (!imageId) {
                        imagePreviewContainer.style.display = 'none';
                        return;
                    }
                    
                    if (confirm('Are you sure you want to remove this image?')) {
                        try {
                            const response = await fetch(`/api/images/${imageId}`, {
                                method: 'DELETE'
                            });
                            
                            if (!response.ok) {
                                throw new Error('Failed to delete image');
                            }
                            
                            // Clear the preview and image ID
                            imageIdInput.value = '';
                            imagePreview.src = '';
                            imagePreviewContainer.style.display = 'none';
                        } catch (error) {
                            alert('Failed to remove image: ' + error.message);
                            console.error('Delete error:', error);
                        }
                    }
                });

                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    errorMessage.style.display = 'none';
                    
                    try {
                        // Format dates - use datetime-local input value but ensure correct formatting for backend
                        const startTimeInput = document.getElementById('startTime').value;
                        const endTimeInput = document.getElementById('endTime').value;
                        
                        if (!startTimeInput || !endTimeInput) {
                            throw new Error("Start time and end time are required");
                        }
                        
                        // Convert to ISO string format for backend
                        const startTime = new Date(startTimeInput).toISOString();
                        const endTime = new Date(endTimeInput).toISOString();
                        
                        // Get selected categories as strings
                        const categoriesSelect = document.getElementById('categories');
                        const selectedCategories = Array.from(categoriesSelect.selectedOptions).map(option => option.value);
                        
                        if (selectedCategories.length === 0) {
                            // Add at least one category if none selected
                            selectedCategories.push("OTHER");
                        }
                        
                        // Create location request
                        const locationRequest = {
                            placeName: document.getElementById('placeName').value,
                            latitude: parseFloat(document.getElementById('latitude').value),
                            longitude: parseFloat(document.getElementById('longitude').value),
                            address: document.getElementById('address').value
                        };
                        
                        // Validate location data
                        if (!locationRequest.placeName || isNaN(locationRequest.latitude) || isNaN(locationRequest.longitude) || !locationRequest.address) {
                            throw new Error("All location fields are required");
                        }
                        
                        // Create the event data
                        const eventData = {
                            title: document.getElementById('title').value,
                            description: document.getElementById('description').value,
                            startTime: startTime,
                            endTime: endTime,
                            capacity: document.getElementById('capacity').value ? parseInt(document.getElementById('capacity').value) : null,
                            categories: selectedCategories,
                            locationRequest: locationRequest,
                            imageId: document.getElementById('imageId').value || null
                        };
                        
                        // Log detailed information about the image ID
                        const imageId = document.getElementById('imageId').value;
                        console.log('Image ID for event creation:', imageId);
                        console.log('Image ID element value:', document.getElementById('imageId').value);
                        console.log('Image ID element:', document.getElementById('imageId'));
                        console.log('Is imageId present in request?', eventData.imageId !== null);
                        console.log('Event data being sent:', JSON.stringify(eventData, null, 2));
                        
                        const eventResponse = await fetch('/events', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(eventData)
                        });
                        
                        if (!eventResponse.ok) {
                            const errorText = await eventResponse.text();
                            console.error('Server error response:', errorText);
                            throw new Error(`Failed to create event: ${errorText || eventResponse.statusText}`);
                        }
                        
                        const eventResult = await eventResponse.json();
                        console.log('Event created successfully:', eventResult);
                        
                        // Redirect to event detail page
                        window.location.href = '/events/' + eventResult.id;
                    } catch (error) {
                        errorMessage.textContent = error.message;
                        errorMessage.style.display = 'block';
                        console.error('Error creating event:', error);
                    }
                });
            });
        </script>
    </th:block>
</body>
</html> 